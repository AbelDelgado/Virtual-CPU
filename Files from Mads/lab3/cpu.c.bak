#define MEMSIZE 16384 //THIS IS 16KB OR W/E I WANT IT TO BE
#define MAXLEN 256 //THIS IS SO NO ONE WRITES A HUGE FILENAME
#include <stdio.h>
#include <string.h>
#include <stdlib.h>


unsigned char memory [MEMSIZE]; //NO BYTE TYPE IN C, THIS IS CLOSEST TO IT

int main ()
{

    int input;	
    char option;
    char buf[BUFSIZ];	
    char bufferHolder [BUFSIZ];



    void WriteFile(void *memory)
    {	
	unsigned char fname[MAXLEN];
	unsigned char numberOfBytes[MAXLEN];
	int writeByte;	
	int writeToFile;			

	/* get file name */
	printf("enter file name: ");
	fgets(fname, MAXLEN, stdin);
	fname[strlen(fname) - 1] = '\0';   // remove line feed character
	printf("***%s*** -> opening file ...\n", fname);

	FILE *f = fopen(fname, "a");
	if (f == NULL)
	{
	    printf("Error opening file: Invalid Name!\n");
	    fclose(f);
	    exit(1);
	}
//	printf("Succuess! Opening %s",fname);
	printf("Enter number of bytes: ");
	fgets (numberOfBytes, MAXLEN,stdin);
	int finalByte = atoi(numberOfBytes);

	if (finalByte < 0)
	{
	    perror("\nNot a valid size!!\n");
	    fclose(f);
	    exit(1);
	}
	if (finalByte > MEMSIZE)
	{
		perror("Size too big. Closing file:\n");
		fclose(f);
		exit(1);
	}
	
	writeToFile = fwrite (memory,sizeof(char), finalByte, f);
	printf("Writing a file with %d bytes\n", writeToFile);
	fclose(f);	
	
    }


    int LoadFile (void * memory, unsigned int max)
    {
	FILE *fptr;
	int bytecnt = 0;
	unsigned char fname[MAXLEN];

	/* get file name */
	printf("enter file name: ");
	fgets(fname, MAXLEN, stdin);
	fname[strlen(fname) - 1] = '\0';   // remove line feed character
	printf("%s -> opening file ...\n", fname);


	/* Open file in read mode */
	if((fptr = fopen(fname, "rb")) == NULL) //rb is for Reading in BINARY mode!!!
	{
	    perror("OOPS!");
	    return -1;
	}else{// Load file into memory
	    bytecnt = fread(memory, 1, MEMSIZE, fptr);
	    printf("Byte count (hex): %X\n", (unsigned int)bytecnt);
	    printf("Byte count (dec): %d\n", (unsigned int)bytecnt);
	    printf("Truncated: ");
	    if(bytecnt == max)
		printf("yes\n");
	    else printf("no\n");
	    fclose(fptr);
	}

	return bytecnt;
    }


    char *trimwhitespace(char *str)
    {
	char *end;

	// Trim leading space
	while(isspace(*str)) str++;

	if(*str == 0)  // All spaces?
	    return str;

	// Trim trailing space
	end = str + strlen(str) - 1;
	while(end > str && isspace(*end)) end--;

	// Write new null terminator
	*(end+1) = 0;

	return str;
    }


    void displayFunctions()
    {
	printf("These are the commands you can enter:\n");
	printf("d - dump memory\n");
	printf("g - run the entire program\n");
	printf("l - load a file into memory\n"); 
	printf("m - memory modify\n");
	printf("q - quit\n");
	printf("r - display registers\n");	
	printf("t - trace\n");
	printf("w - write file\n");
	printf("z - reset all registers to zero\n");
	printf("h,? - display list of commads\n");	
    }





    void menuFunction()
    {
	while(1)
	{
	    fflush(stdout);
	    printf(">:");

	    if (fgets (buf, sizeof(buf), stdin) != NULL)
	    {

		//		printf("You entered: %s\n", trimwhitespace(buf));
		bufferHolder[1] =* trimwhitespace(buf);
		
		//		printf("Stringz is %c\n",stringz[1]);
	
		option = (char)(bufferHolder[1]);
		option =  (tolower(option));
//		printf("Final choice: ***%c***\n",option);
		

	    }	


	    switch (option)
	    {
		case 'd':
		    printf("This gives memory dump\n");
		    break;
		case 'q':
		    exit(0);	
		case 'h':
		    displayFunctions();
		    break;			
		case 'g':
		    printf("Runs the entire program\n");
		    break;
		case 'l':	
		    printf("Load goes here\n");
		    LoadFile(memory, sizeof(memory));
		    break;
		case 'm':
		    printf("memory modify\n");
		    break;
		case 'r':
		    printf("display registers\n");
		    break;
		case 't':
		    printf("Trace stuff\n");
		    break;
		case 'w':
		    printf("Write to a file\n");
		    WriteFile(memory);
		    break;
		case 'z':
		    printf("Registers are 0\n");
		    break;	
		case '?':
		    displayFunctions();
		    break;				
	    }	
	}
    }
	
    printf("Name: Abel Deglado\n");
    printf("Enter h for help\n");
    menuFunction();
    //	displayFunctions();
}

